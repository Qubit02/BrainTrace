##### 0) base ########################################################
FROM python:3.12-slim AS base
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
WORKDIR /app

##### 1) deps ########################################################
FROM base AS deps
RUN apt-get update \
 && apt-get install -y --no-install-recommends openjdk-21-jre-headless \
 && rm -rf /var/lib/apt/lists/*
ENV JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64

##### 2) builder: ì˜ì¡´ì„± ì„¤ì¹˜ í›„ /install ë¡œ ë³µì‚¬ ####################
FROM deps AS builder
COPY requirements.txt .
# --prefix=/install  ğŸ‘‰  íŒŒì´ì¬ íŒ¨í‚¤ì§€ë¥¼ ì§€ì • ê²½ë¡œë¡œ â€œì„¤ì¹˜ë³¸ë§Œâ€ ë°°ì¶œ
RUN pip install --upgrade pip \
 && pip install --no-cache-dir --prefix=/install -r requirements.txt \
 && pip cache purge

##### 3) dev #########################################################
FROM deps AS dev
# ì„¤ì¹˜ë³¸ë§Œ ë³µì‚¬ (íœ  X)
COPY --from=builder /install /usr/local
# ì½”ë“œ ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸í•  ê±°ë¼ë©´ COPY ìƒëµ ê°€ëŠ¥
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
