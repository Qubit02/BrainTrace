# AI Agent 기반 자가 치유(Self-Healing) 오류 복구 메커니즘

## 개요

질문-답변 파이프라인의 각 단계에서 오류가 발생할 경우, AI Agent가 오류를 분석하고 자동으로 복구 방안을 제시하여 해당 단계로 돌아가 문제를 해결한 후 답변을 생성하는 자가 치유 메커니즘을 구현했습니다.

## 동작 원리

### 1. 오류 감지 및 정보 수집

각 단계에서 오류 발생 시 다음 정보를 수집합니다:

- **오류 유형**: Exception 클래스 이름
- **오류 메시지**: 상세 오류 내용
- **발생 단계**: 오류가 발생한 단계 이름
- **시도 횟수**: 현재 재시도 횟수
- **컨텍스트**: 질문, 노드 개수, 스키마 정보 등

### 2. 오류 복구 Agent 실행

수집된 오류 정보를 AI Agent에 전달하여 복구 방안을 제시받습니다.

**복구 방안 종류:**

- **retry**: 동일한 파라미터로 재시도
- **modify**: 파라미터 수정 후 재시도 (retry_params에 수정 사항 포함)
- **skip**: 현재 단계 건너뛰고 다음 단계 진행
- **fallback**: 대체 방법 사용 (예: 일반 지식으로 답변)

### 3. 복구 방안 실행 및 재시도

복구 방안에 따라:

- **retry**: 즉시 재시도
- **modify**: 파라미터 수정 후 재시도
- **skip**: 현재 단계 건너뛰기
- **fallback**: 대체 방법으로 진행

### 4. 최대 재시도 횟수 제한

각 단계별로 최대 3회까지 재시도하며, 초과 시 대체 방법으로 진행합니다.

## 적용된 단계별 오류 복구

### 1. 노드 품질 평가 Agent (Step 3)

**오류 발생 시:**

```
⚠️  [노드 품질 평가] 오류 발생 (시도 1/3): JSONDecodeError...
🔧 오류 복구 Agent 실행 중...
🔧 복구 방안: retry - JSON 파싱 오류는 일시적일 수 있으므로 재시도 권장
🔄 재시도 중...
```

**복구 방안:**

- **retry**: JSON 파싱 오류 등 일시적 오류 시 재시도
- **skip**: 복구 불가 시 원본 노드 사용

### 2. 스키마 조회 (Step 4)

**오류 발생 시:**

```
⚠️  [스키마 조회] 오류 발생 (시도 1/3): ConnectionError...
🔧 오류 복구 Agent 실행 중...
🔧 복구 방안: modify - 네트워크 오류 시 deep_search 옵션 변경 후 재시도
🔄 파라미터 수정: use_deep_search=False
🔄 재시도 중...
```

**복구 방안:**

- **retry**: 일시적 연결 오류 시 재시도
- **modify**: deep_search 옵션 변경 후 재시도
- **fallback**: 복구 불가 시 일반 지식으로 답변

### 3. 스키마 충분성 판단 Agent (Step 5)

**오류 발생 시:**

```
⚠️  [스키마 충분성 판단] 오류 발생 (시도 1/3): TimeoutError...
🔧 오류 복구 Agent 실행 중...
🔧 복구 방안: skip - 타임아웃 시 기본값 사용하여 진행
⏭️  현재 단계 건너뛰기 (기본값 사용)
```

**복구 방안:**

- **retry**: 일시적 오류 시 재시도
- **skip**: 복구 불가 시 기본값(is_sufficient=True) 사용

### 4. 스키마 텍스트 최적화 Agent (Step 7)

**오류 발생 시:**

```
⚠️  [스키마 텍스트 최적화] 오류 발생 (시도 1/3): ValueError...
🔧 오류 복구 Agent 실행 중...
🔧 복구 방안: skip - 최적화 실패 시 원본 텍스트 사용
⏭️  현재 단계 건너뛰기 (원본 스키마 텍스트 사용)
```

**복구 방안:**

- **retry**: 일시적 오류 시 재시도
- **skip**: 복구 불가 시 원본 스키마 텍스트 사용

### 5. LLM 답변 생성 (Step 8)

**오류 발생 시:**

```
⚠️  [LLM 답변 생성] 오류 발생 (시도 1/3): RateLimitError...
🔧 오류 복구 Agent 실행 중...
🔧 복구 방안: modify - 레이트 리밋 오류 시 스키마 텍스트 단순화 후 재시도
🔄 스키마 텍스트 단순화 후 재시도
```

**복구 방안:**

- **retry**: 일시적 오류 시 재시도
- **modify**: 스키마 텍스트 단순화 후 재시도 (토큰 수 감소)
- **fallback**: 복구 불가 시 일반 지식으로 답변

## 터미널 로그 예시

### 정상 실행

```
📋 [1] 질문 수신 | 모델: GPT-4o (openai)
💬 질문: 파이썬이란 무엇인가요?
🔍 [2] 유사 노드 검색 중...
🤖 [3] AI Agent: 노드 품질 평가 중... (검색된 노드: 7개)
✓ 최적화 완료: 7개 → 4개 (관련성 낮은 노드 3개 제거)
🗺️  [4] 스키마 조회 중...
✓ 스키마 조회 완료: 노드 10개, 관계 8개
🤖 [5] AI Agent: 스키마 충분성 판단 중...
✓ 충분성 판단: 현재 스키마로 답변 가능
📝 [6] 스키마 텍스트 생성 중...
  → 원본 스키마 텍스트: 2,450자
🤖 [7] AI Agent: 스키마 텍스트 최적화 중...
✓ 최적화 완료: 2,450자 → 1,230자 (불필요한 정보 1,220자 제거, 49.8% 감소)
💡 [8] LLM 답변 생성 중...
📊 [9] 후처리: 참조 노드 추출 및 정확도 계산 중...
✅ [10] 완료 | 답변 생성 완료 (정확도: 0.85)
```

### 오류 발생 및 복구 예시

```
📋 [1] 질문 수신 | 모델: GPT-4o (openai)
💬 질문: 파이썬이란 무엇인가요?
🔍 [2] 유사 노드 검색 중...
🤖 [3] AI Agent: 노드 품질 평가 중... (검색된 노드: 7개)
⚠️  [노드 품질 평가] 오류 발생 (시도 1/3): JSONDecodeError: Expecting value
🔧 오류 복구 Agent 실행 중...
🔧 복구 방안: retry - JSON 파싱 오류는 일시적일 수 있으므로 재시도 권장
🔄 재시도 중...
✓ 최적화 완료: 7개 → 4개 (관련성 낮은 노드 3개 제거)
🗺️  [4] 스키마 조회 중...
⚠️  [스키마 조회] 오류 발생 (시도 1/3): ConnectionError: Connection timeout
🔧 오류 복구 Agent 실행 중...
🔧 복구 방안: retry - 네트워크 오류는 일시적일 수 있으므로 재시도 권장
🔄 재시도 중...
✓ 스키마 조회 완료: 노드 10개, 관계 8개
...
💡 [8] LLM 답변 생성 중...
⚠️  [LLM 답변 생성] 오류 발생 (시도 1/3): RateLimitError: Rate limit exceeded
🔧 오류 복구 Agent 실행 중...
🔧 복구 방안: modify - 레이트 리밋 오류 시 스키마 텍스트 단순화 후 재시도
🔄 스키마 텍스트 단순화 후 재시도
💡 [8] LLM 답변 생성 중...
✅ [10] 완료 | 답변 생성 완료 (정확도: 0.82)
```

## 주요 특징

### 1. 지능적 오류 분석

AI Agent가 오류 유형과 컨텍스트를 분석하여 최적의 복구 방안을 제시합니다.

### 2. 적응적 복구 전략

오류 유형에 따라 다른 복구 전략을 적용:

- **일시적 오류**: 재시도
- **파라미터 문제**: 수정 후 재시도
- **복구 불가**: 대체 방법 사용

### 3. 안정성 보장

최대 재시도 횟수 제한으로 무한 루프 방지, 복구 실패 시 대체 방법으로 진행하여 항상 답변 제공

### 4. 투명한 로깅

각 오류와 복구 과정을 상세히 로깅하여 디버깅 및 모니터링 용이

## 학술적 기여

### 1. 자가 치유 파이프라인

오류 발생 시 자동으로 복구하는 자가 치유(Self-Healing) 메커니즘을 구현하여 시스템 안정성과 신뢰성을 크게 향상시켰습니다.

### 2. AI 기반 오류 복구

단순 재시도가 아닌 AI Agent가 오류를 분석하고 최적의 복구 방안을 제시하는 지능형 오류 복구 시스템을 제안했습니다.

### 3. 적응적 복구 전략

오류 유형과 컨텍스트에 따라 동적으로 복구 전략을 조정하는 적응적 메커니즘을 구현했습니다.

## 결론

AI Agent 기반 자가 치유 오류 복구 메커니즘을 통해 질문-답변 파이프라인의 안정성과 신뢰성을 크게 향상시켰습니다. 오류 발생 시에도 자동으로 복구하여 사용자에게 항상 답변을 제공할 수 있도록 보장합니다.
